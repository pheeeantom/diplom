<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Test - Blockly</title>
		<script src="blockly/blockly_compressed.js"></script>
		<script src="blockly/blocks_compressed.js"></script>
		<script src="blockly/generators/bml.js"></script>
		<script src="blockly/msg/ru.js"></script>
	</head>
	<body>
		<div id="blocklyDiv" style="position: absolute;"></div>
		<div id="blocklyArea" style="width:10000px;height:2000px"></div>
		<!--<xml id="toolbox" style="display: none">
		    <category name="Text">
			    <block type="string_length"></block>
			  </category>
		</xml>-->
		<textarea id="textarea">
		</textarea>
		<script>
		/*Blockly.Blocks['string_length'] = {
			  init: function() {
			    this.jsonInit(
					{
					  "message0": "length of %1",
					  "args0": [
					    {
					      "type": "field_input",
					      "name":"VALUE"
					    }
					  ]
					}
			    );
			  }
			};
		  var workspace = Blockly.inject('blocklyDiv',
		      {toolbox: document.getElementById('toolbox')});
			function myUpdateFunction(event) {
			  var code = Blockly.bml.workspaceToCode(workspace);
			  document.getElementById('textarea').value = code;
			}
			workspace.addChangeListener(myUpdateFunction);*/
			  var blocklyArea = document.getElementById('blocklyArea');
  			var blocklyDiv = document.getElementById('blocklyDiv');
			var defaultOptions = {
			  comments: true,
			  // ...
			  toolbox: bmlToolbox,
			  // ...
			};
			var workspace = Blockly.inject('blocklyDiv', defaultOptions);
			var onresize = function(e) {
		    // Compute the absolute coordinates and dimensions of blocklyArea.
		    var element = blocklyArea;
		    var x = 0;
		    var y = 0;
		    do {
		      x += element.offsetLeft;
		      y += element.offsetTop;
		      element = element.offsetParent;
		    } while (element);
		    // Position blocklyDiv over blocklyArea.
		    blocklyDiv.style.left = x + 'px';
		    blocklyDiv.style.top = y + 'px';
		    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
		    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
		    Blockly.svgResize(workspace);
		  };
		  window.addEventListener('resize', onresize, false);
		  onresize();

		  /*function findDescendants(root, sets) {
		  	if (root.inputList[3].connection.targetConnection == null) {
		  		return;
		  	}
		  	root = root.inputList[3].connection.targetConnection.getSourceBlock();
		  	//console.log(root);
		  	var next = root;
		  	if (next.type == "set") {
				sets.push(next);
			}
			while (next.nextConnection.targetConnection != null) {
				next = next.nextConnection.targetConnection.getSourceBlock();
				if (next.type == "set") {
					sets.push(next);
				}
				findDescendants(next, sets);
			}
			//console.log(root);
		  }*/

		  /*function findIds(set, ids) {
		  	if ()
		  	while (set.inputList[2].connection.targetConnection.getSourceBlock()) {

		  	}
		  }*/

		  var idsRoot = [];
		  var idsBlock = [];
		  //var flagSelected = false;

		  function updateId(id) {
		  	if (id.type == 'attr_set_id') {
		  		Blockly.Events.fire(new (Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(id, 'collapsed', null, id.collapsed_, id.inputList[0].fieldRow[1].getValue()));
		  	}
		  }

		  Blockly.svgResize(workspace);
			function myUpdateFunction(event) {
				var fileAttrs = [
					"attr_block_path",
					"attr_block_mimes"
				];
				var imageAttrs = [
					"attr_block_width",
					"attr_block_height",
					"attr_block_resize"
				];
				var archiveAttrs = [
					"attr_block_method",
					"attr_block_ratio",
					"attr_block_comment",
					"attr_block_unpacked_size"
				];
				var warningAttrs = fileAttrs.concat(imageAttrs).concat(archiveAttrs);
				var imageAttrs = fileAttrs.concat(imageAttrs);
				var archiveAttrs = fileAttrs.concat(archiveAttrs);
				/*if (event.type != Blockly.Events.SELECTED)
					flagSelected = false;
				if (event.type == Blockly.Events.SELECTED) {
					if (workspace.getBlockById(event.newElementId) != null && workspace.getBlockById(event.newElementId).type == "attr_set_id") {
						console.log("q");

						//Blockly.Events.fire(new (Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(workspace.getBlockById(event.newElementId), 'collapsed', null, workspace.getBlockById(event.newElementId).collapsed_, workspace.getBlockById(event.newElementId).inputList[0].fieldRow[1].getValue()));
						if (!flagSelected) {
							Blockly.Events.fire(new (Blockly.Events.get(Blockly.Events.BLOCK_MOVE))(workspace.getBlockById(event.newElementId)));
							Blockly.Events.fire(new (Blockly.Events.get(Blockly.Events.SELECTED))(event.newElementId, event.newElementId, event.workspaceId));
						}
						flagSelected = true;
					}
					else {
						flagSelected = false;
					}
				}*/
						/*var next = workspace.getBlockById(event.newElementId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							console.log("cycle");
							if (next.type == "set_model_second" || next.type == "set_location") {
								var idsStr = [];
								for (var i = 0; i < idsRoot.length; i++) {
									idsStr.push(Object.values(idsRoot[i])[0]);
								}
								var idsRes = [];
					            for (var i = 0; i < idsStr.length; i++)
					            	idsRes.push([idsStr[i], idsStr[i]]);
					            if (idsRes.length == 0)
					            	idsRes = [["",""]];
					            var conn;
					            if (workspace.getBlockById(event.newElementId).getInputTargetBlock('NEXT') != null)
					            	conn = workspace.getBlockById(event.newElementId).getInputTargetBlock('NEXT')
					            		.outputConnection;
					            workspace.getBlockById(event.newElementId).getField('ID').dispose();
								workspace.getBlockById(event.newElementId).removeInput('NEXT', true);
							    workspace.getBlockById(event.newElementId).jsonInit({
								  "type": "attr_set_id",
								  "message0": "id of set %1 ----> %2",
								  "args0": [
								    {
								      "type": "field_dropdown",
								      "name": "ID",
								      "options": idsRes
								    },
								    {
								      "type": "input_value",
								      "name": "NEXT",
								      "check": attr_set
								    }
								  ],
								  "colour": "180",
								  "output": attr_set
								  //"output": "attr"
								});
								if (conn != undefined)
									workspace.getBlockById(event.newElementId).getInput('NEXT').connection.connect(conn);
								break;
							}
						}
						return;
					}
				}*/
					/*var next = workspace.getBlockById(event.newElementId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							if (next.type == "set_model_second") {
								var conn1 = workspace.getBlockById(event.newElementId).outputConnection;
					            var conn2;
					            if (workspace.getBlockById(event.newElementId).outputConnection.targetConnection
					            		.getSourceBlock().type.startsWith("attr_set_")) {
					            	conn2 = workspace.getBlockById(event.newElementId).outputConnection.targetConnection
					            		.getSourceBlock().getInput('NEXT').connection;
					            }
					            else if (workspace.getBlockById(event.newElementId).outputConnection.targetConnection
					            		.getSourceBlock().type == "set_model_second") {
					            	conn2 = workspace.getBlockById(event.newElementId).outputConnection.targetConnection
					            		.getSourceBlock().getInput('ATTRS').connection;
					            }
					            conn1.disconnect();
					            conn1.connect(conn2);
					        }
				        }
				    }
				}*/
				if (event.type == Blockly.Events.BLOCK_DELETE) {
					console.log("delete");
					idsRoot = idsRoot.filter(idRoot => {
						return event.ids.includes(Object.keys(idsRoot)[0]);
					});
					console.log(idsRoot);
				}
				if (event.type == Blockly.Events.BLOCK_CHANGE) {
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "attr_set_id") {
						console.log("w");
						var next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							if (next.type == "set_model_first") {
								for (var i = 0; i < idsRoot.length; i++) {
									var obj = idsRoot[i];
									var name = event.blockId;
									if (obj[name] !== undefined) {
										idsRoot.splice(i, 1);
									}
								}
								var obj = {};
								var name = event.blockId;
								var val = event.newValue;
								obj[name] = val;
								idsRoot.push(obj);
								break;
							}
							/*if (next.type == "set_model_second") {
								while (next.previousConnection != null && next.previousConnection.targetConnection != null) {
									next = next.previousConnection.targetConnection.getSourceBlock();
									if (next.previousConnection.targetConnection.getSourceBlock().type == "model") {
										for (var i = 0; i < idsRoot.length; i++) {
											var obj = idsRoot[i];
											var name = event.blockId;
											if (obj[name] !== undefined) {
												idsRoot.splice(i, 1);
											}
										}
										var obj = {};
										var name = event.blockId;
										var val = event.newValue;
										obj[name] = val;
										idsRoot.push(obj);
										break;
									}
								}
							}*/
								/*var idsStr = [];
								for (var i = 0; i < ids.length; i++) {
									idsStr.push(Object.values(ids[i])[0]);
								}
								console.log(idsStr);
								if (!idsStr.includes(event.newValue)) {
									workspace.getBlockById(event.blockId).setColour(0);
								}
								else {
									workspace.getBlockById(event.blockId).setColour(180);
								}
								break;
							}
							if (next.type == "model") {
								for (var i = 0; i < ids.length; i++) {
									var obj = ids[i];
									var name = event.blockId;
									if (obj[name] !== undefined) {
										ids.splice(i, 1);
									}
								}
								var obj = {};
								var name = event.blockId;
								var val = event.newValue;
								obj[name] = val;
								ids.push(obj);
								break;
							}*/
						}
					}
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "attr_block_id") {
						console.log("v");
						var next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							if (next.type == "block_model") {
								if (next.previousConnection == null) {
									break;
								}
								for (var i = 0; i < idsBlock.length; i++) {
									var obj = idsBlock[i];
									var name = event.blockId;
									if (obj[name] !== undefined) {
										idsBlock.splice(i, 1);
									}
								}
								var obj = {};
								var name = event.blockId;
								let child = next.previousConnection.targetConnection.getSourceBlock();
						    	let root = child.getParent();
						    	if (root != null) {
							    	while (root != null && root.getInputTargetBlock("DO") != child) {
							    		child = child.getParent();
							    		root = child.getParent();
							    	}
							    }
								console.log(root);
								var id;
								next = root.getInputTargetBlock('ATTRS');
								var first = true;
								do {
									if (!first) {
										next = next.getInputTargetBlock("NEXT");
									}
									first = false;
									console.log(next);
									if (next.type === "attr_set_id") {
										id = next.inputList[0].fieldRow[1].getValue();
									}
								} while (next.getInputTargetBlock("NEXT") != null);
								var val = event.newValue;
								obj[name] = [val,id];
								idsBlock.push(obj);
								console.log(idsBlock);
								break;
							}
						}
					}
					//console.log(ids);
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "attr_block_type") {
						var nexts = [];
						//Blockly.Events.fire(new (Blockly.Events.get(Blockly.Events.BLOCK_MOVE))(workspace.getBlockById(event.blockId)));
						var next = workspace.getBlockById(event.blockId);
						while (next.getInputTargetBlock("NEXT") != null) {
							next = next.getInputTargetBlock("NEXT");
							//console.log(next.type);
					    	//console.log(root.type);
							if (!((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "file"
								&& fileAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "image"
								&& imageAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "archive"
								&& archiveAttrs.includes(next.type)))
								&& (!(workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number")
								&& warningAttrs.includes(next.type)
								|| ((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(next.type)))) {
								//console.log(root.type);
								console.log('hello-2.1');
								//console.log(workspace.getBlockById(event.blockId).getInputTargetBlock('NEXT'));
								//console.log(workspace.getBlockById(event.blockId));
								//workspace.getBlockById(event.blockId).inputList[0].connection.disconnect();
								//console.log(next);
								//next.outputConnection.disconnect();
								//next.outputConnection.disconnect();
								nexts.push(next);
								
								/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
									var nextConn = workspace.getBlockById(event.blockId).nextConnection;
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									prevConn.connect(nextConn);
								}*/
								//console.log('hello');
								//return;
							}
						}
						next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null
							&& next.outputConnection.targetConnection.getSourceBlock().type != "block_model"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "block_location"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_model_first"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_model_second"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_location") {
							//console.log('hello');
							next = next.outputConnection.targetConnection.getSourceBlock();
							//console.log(next.type);
					    	//console.log(root.type);
							if (!((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "file"
								&& fileAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "image"
								&& imageAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "archive"
								&& archiveAttrs.includes(next.type)))
								&& (!(workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number")
								&& warningAttrs.includes(next.type)
								|| ((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(next.type)))) {
								console.log('hello-2.2');
								nexts.push(next);
								//console.log(root.type);
								/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
									var nextConn = workspace.getBlockById(event.blockId).nextConnection;
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									prevConn.connect(nextConn);
								}*/
								//console.log('hello');
								//return;
							}
						}
						console.log(nexts);
						nexts.forEach((next) => {
							next.outputConnection.disconnect();
							if (next.getInputTargetBlock("NEXT") != null) {
								next.getInputTargetBlock("NEXT").outputConnection.disconnect();
							}
							next.moveBy(50,50);
							next.workspace.getAudioManager().play('disconnect');
						});
					}
				}

				if (event.type == Blockly.Events.BLOCK_MOVE) {
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "attr_block_id") {
						var next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							if (next.type == "block_location") {
								let child = next.previousConnection.targetConnection.getSourceBlock();
						    	let root = child.getParent();
						    	if (child.type === "set_location") {
						    		root = child;
						    	}
						    	else {
						    		if (root != null) {
								    	while (root != null && root.getInputTargetBlock("DO") != child) {
								    		child = child.getParent();
								    		root = child.getParent();
								    	}
								    }
						    	}
							    console.log(root);
								var id;
								next = root.getInputTargetBlock('ATTRS');
								var first = true;
								do {
									if (!first) {
										next = next.getInputTargetBlock("NEXT");
									}
									first = false;
									console.log(next);
									if (next.type === "attr_set_id") {
										id = next.inputList[0].fieldRow[1].getValue();
									}
								} while (next.getInputTargetBlock("NEXT") != null);
								console.log(id);
								var idsStr = [];
								for (var i = 0; i < idsBlock.length; i++) {
									if (Object.values(idsBlock[i])[0][1] == id) {
										idsStr.push(Object.values(idsBlock[i])[0][0]);
									}
								}
								console.log(idsStr);
								console.log(workspace.getBlockById(event.blockId).getField("ID"));
								//workspace.getBlockById(event.blockId).getField('ID').dispose();
								//workspace.getBlockById(event.blockId).getField('NEXT').dispose();
								/*workspace.getBlockById(event.blockId).appendDummyInput().appendField(new Blockly.FieldDropdown(
							        function () {
							            var idsRes = [];
							            for (var i = 0; i < idsStr.length; i++)
							            	idsRes.push([idsStr[i], idsStr[i]]);
							            return idsRes;
							        }
							    ), 'ID');*/
							    var idsRes = [];
					            for (var i = 0; i < idsStr.length; i++)
					            	idsRes.push([idsStr[i], idsStr[i]]);
					            if (idsRes.length == 0)
					            	idsRes = [["",""]];
					            var conn;
					            if (workspace.getBlockById(event.blockId).getInputTargetBlock('NEXT') != null)
					            	conn = workspace.getBlockById(event.blockId).getInputTargetBlock('NEXT')
					            		.outputConnection;
					            workspace.getBlockById(event.blockId).getField('ID').dispose();
					            workspace.getBlockById(event.blockId).removeInput('NEXT', true);
							    workspace.getBlockById(event.blockId).jsonInit({
								  "type": "attr_block_id",
								  "message0": "id of block %1 ----> %2",
								  "args0": [
								    {
								      "type": "field_dropdown",
								      "name": "ID",
								      "options": idsRes
								    },
								    {
								      "type": "input_value",
								      "name": "NEXT",
								      "check": attr_block
								    }
								  ],
								  "colour": "180",
								  "output": attr_block
								  //"output": "attr"
								});
								if (conn != undefined)
									workspace.getBlockById(event.blockId).getInput('NEXT').connection.connect(conn);
							    //workspace.getBlockById(event.blockId).appendValueInput('NEXT')
									//.setCheck(attr_set)
									//.appendField('---->');
										//.appendField('length of');
								/*if (!idsStr.includes(event.newValue)) {
									workspace.getBlockById(event.blockId).setColour(0);
								}
								else {
									workspace.getBlockById(event.blockId).setColour(180);
								}*/
								break;
							}
							/*else if (next.type == "block_location") {
								var next2 = next;
								while (next2.outputConnection == null) {
									next2 = next.previousConnection.targetConnection.getSourceBlock();
									if (next2.type == "set_location") {

									}
								}
							}*/
						}
					}
					/*if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "block_model") {
						var next = workspace.getBlockById(event.blockId);
						while (next.outputConnection == null) {
							next = next.previousConnection.targetConnection.getSourceBlock();
							if (next.outputConnection.targetConnection.getSourceBlock().type == "set_model_first") {
								idsBlock.forEach(idBlock => {
									if (Object.keys(idBlock)[0] == next.outputConnection.targetConnection.getSourceBlock()
										.id)
								if ()
								var obj = {};
								var name = null;
								var next2 = next.outputConnection.targetConnection.getSourceBlock()
									.getInputTargetBlock('ATTRS');
								while (next2 != null) {
									next2 = next2.getInputTargetBlock('NEXT');
									if (next2.type == "attr_set_id") {
										name = next2.getField('ID');
										break;
									}
								}
								if (name != null) {
									var val = null;
									next2 = workspace.getBlockById(event.blockId).getInputTargetBlock('ATTRS');
									while (next2 != null) {
										next2 = next2.getInputTargetBlock('NEXT');
										if (next2.type == "attr_block_id") {
											val = next2.getField('ID');
											break;
										}
									}
									obj[name] = val;
									idsBlock.push(obj);
								}
							}
						}
					}*/
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "attr_set_id") {
						var next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							if (next.type == "set_model_second" || next.type == "set_location") {
								var idsStr = [];
								for (var i = 0; i < idsRoot.length; i++) {
									idsStr.push(Object.values(idsRoot[i])[0]);
								}
								console.log(idsStr);
								console.log(workspace.getBlockById(event.blockId).getField("ID"));
								//workspace.getBlockById(event.blockId).getField('ID').dispose();
								//workspace.getBlockById(event.blockId).getField('NEXT').dispose();
								/*workspace.getBlockById(event.blockId).appendDummyInput().appendField(new Blockly.FieldDropdown(
							        function () {
							            var idsRes = [];
							            for (var i = 0; i < idsStr.length; i++)
							            	idsRes.push([idsStr[i], idsStr[i]]);
							            return idsRes;
							        }
							    ), 'ID');*/
							    var idsRes = [];
					            for (var i = 0; i < idsStr.length; i++)
					            	idsRes.push([idsStr[i], idsStr[i]]);
					            if (idsRes.length == 0)
					            	idsRes = [["",""]];
					            var conn;
					            if (workspace.getBlockById(event.blockId).getInputTargetBlock('NEXT') != null)
					            	conn = workspace.getBlockById(event.blockId).getInputTargetBlock('NEXT')
					            		.outputConnection;
					            workspace.getBlockById(event.blockId).getField('ID').dispose();
					            workspace.getBlockById(event.blockId).removeInput('NEXT', true);
							    workspace.getBlockById(event.blockId).jsonInit({
								  "type": "attr_set_id",
								  "message0": "id of set %1 ----> %2",
								  "args0": [
								    {
								      "type": "field_dropdown",
								      "name": "ID",
								      "options": idsRes
								    },
								    {
								      "type": "input_value",
								      "name": "NEXT",
								      "check": attr_set
								    }
								  ],
								  "colour": "180",
								  "output": attr_set
								  //"output": "attr"
								});
								if (conn != undefined)
									workspace.getBlockById(event.blockId).getInput('NEXT').connection.connect(conn);
							    //workspace.getBlockById(event.blockId).appendValueInput('NEXT')
									//.setCheck(attr_set)
									//.appendField('---->');
										//.appendField('length of');
								/*if (!idsStr.includes(event.newValue)) {
									workspace.getBlockById(event.blockId).setColour(0);
								}
								else {
									workspace.getBlockById(event.blockId).setColour(180);
								}*/
								break;
							}
							/*else if (next.type == "block_location") {
								var next2 = next;
								while (next2.outputConnection == null) {
									next2 = next.previousConnection.targetConnection.getSourceBlock();
									if (next2.type == "set_location") {

									}
								}
							}*/
						}
					}
					if (workspace.getBlockById(event.blockId) != null
						&& (workspace.getBlockById(event.blockId).type === "block_location"
						|| workspace.getBlockById(event.blockId).type === "set_location")) {
						//console.log('kkk');
						let child = workspace.getBlockById(event.blockId);
				    	let root = child.getParent();
				    	if (root != null) {
					    	while (root != null && root.getInputTargetBlock("DO") != child) {
					    		child = child.getParent();
					    		root = child.getParent();
					    	}
				    		if (workspace.getBlockById(event.blockId).type === "block_location") {
				    			if (root != null && (root.type === "model" || root.type === "location")) {
				    				console.log('hello-1');
					    			workspace.getBlockById(event.blockId).previousConnection.disconnect();
					    			return;
					    		}
				    		}
				    		if (workspace.getBlockById(event.blockId).type === "set_location") {
				    			//console.log('hello');
				    			var next = workspace.getBlockById(event.blockId);
				    			while (next.nextConnection != null && next.nextConnection.targetConnection != null) {
									next = next.nextConnection.targetConnection.getSourceBlock();
									//console.log(next.type);
							    	//console.log(root.type);
									if (root != null
										&& (next.type == 'block_location' && (root.type == 'location' ||
										root.type == 'model'))) {
										//console.log(root.type);
										console.log('hello0');
										workspace.getBlockById(event.blockId).previousConnection.disconnect();
										return;
									}
								}
				    		}
				    	}
					    	/*let root = workspace.getBlockById(event.blockId).getParent();
					    	while (root.type !== "group" && root.type !== "model" && root.type !== "location") {
					    		root = root.getParent();
					    	}
					    	if (root.type === "model" || root.type === "location") {
					    		workspace.getBlockById(event.blockId).previousConnection.disconnect();
					    	}*/
					    	/*let root = workspace.getBlockById(event.blockId);
					    	while (root.getOnlyValueConnection_() === null) {
					    		root = root.getParent();
					    	}*/
					}
					workspace.getAllBlocks(false).forEach(block => updateId(block));
					/*if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type == "attr_set_id") {
						var next = workspace.getBlockById(event.blockId);
						while (next.previousConnection.targetConnection != null) {
							next = next.previousConnection.targetConnection.getSourceBlock();
							if (next.type == "model") {
								//console.log('mod');
								break;
							}
							if (next.type == "location") {
								//console.log('loc');
								while (next.previousConnection.targetConnection != null) {
									next = next.previousConnection.targetConnection.getSourceBlock();
									if (next.type == "model") {
										if (next.inputList[1].connection.targetConnection != null) {
											var root = next.inputList[1].connection.targetConnection.getSourceBlock();
											var sets = [root];
											next = root;
											while (next.nextConnection.targetConnection != null) {
												next = next.nextConnection.targetConnection.getSourceBlock();
												if (next.type == "set") {
													sets.push(next);
												}
											}
											//console.log(sets);
											sets.forEach(set => findDescendants(set, sets));
											sets.forEach(set => findIds(set, ids));
											break;
										}
									}
								}
							}
						}
					}*/
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type.startsWith("attr_")) {
						var next = workspace.getBlockById(event.blockId);
						//console.log(next.childBlocks_[0].type);
						var nextTypes = [];
						while (next.getInputTargetBlock("NEXT") != null) {
							next = next.getInputTargetBlock("NEXT");
							nextTypes.push(next.type);
							if (next.type == workspace.getBlockById(event.blockId).type) {
								console.log('hello0.1');
								next.outputConnection.disconnect();
								return;
							}
						}
						next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null) {
							next = next.outputConnection.targetConnection.getSourceBlock();
							if (next.type == workspace.getBlockById(event.blockId).type) {
								console.log('hello0.2');
								next.outputConnection.disconnect();
								return;
							}
							//console.log(nextTypes);
							//console.log(next.type);
							if (nextTypes.includes(next.type)) {
								console.log('hello0.3');
								next.outputConnection.disconnect();
								return;
							}
						}
					}
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type == "attr_block_type") {
						//console.log('HELLO');
						var next = workspace.getBlockById(event.blockId);
						while (next.getInputTargetBlock("NEXT") != null) {
							next = next.getInputTargetBlock("NEXT");
							//console.log(next.type);
					    	//console.log(root.type);
							if (!((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "file"
								&& fileAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "image"
								&& imageAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "archive"
								&& archiveAttrs.includes(next.type)))
								&& (!(workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number")
								&& warningAttrs.includes(next.type)
								|| ((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(next.type)))) {
								//console.log(root.type);
								console.log('hello1');
								//console.log(workspace.getBlockById(event.blockId).getInputTargetBlock('NEXT'));
								//console.log(workspace.getBlockById(event.blockId).inputList[0].connection);
								next.outputConnection.disconnect();
								/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
									var nextConn = workspace.getBlockById(event.blockId).nextConnection;
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									prevConn.connect(nextConn);
								}*/
								//console.log('hello');
								return;
							}
						}
						next = workspace.getBlockById(event.blockId);
						while (next.outputConnection != null && next.outputConnection.targetConnection != null
							&& next.outputConnection.targetConnection.getSourceBlock().type != "block_model"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "block_location"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_model_first"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_model_second"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_location") {
							//console.log('hello');
							next = next.outputConnection.targetConnection.getSourceBlock();
							//console.log(next.type);
					    	//console.log(root.type);
							if (!((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "file"
								&& fileAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "image"
								&& imageAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "archive"
								&& archiveAttrs.includes(next.type)))
								&& (!(workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number")
								&& warningAttrs.includes(next.type)
								|| ((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(next.type)))) {
								console.log('hello2');
								//console.log(root.type);
								next.outputConnection.disconnect();
								/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
									var nextConn = workspace.getBlockById(event.blockId).nextConnection;
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									prevConn.connect(nextConn);
								}*/
								//console.log('hello');
								return;
							}
						}
					}
					if (workspace.getBlockById(event.blockId) != null
						&& warningAttrs.includes(workspace.getBlockById(event.blockId).type)) {
						//console.log(12345);
						//console.log('hello1');
						var hasName = false; 
						var next = workspace.getBlockById(event.blockId);
						while (next.getInputTargetBlock("NEXT") != null) {
							next = next.getInputTargetBlock("NEXT");
							//console.log(next.type);
					    	//console.log(root.type);
							if (next.type == "attr_block_type") {
								hasName = true;
								if (!((next.inputList[0].fieldRow[1].getValue() == "file"
									&& fileAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "image"
									&& imageAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "archive"
									&& archiveAttrs.includes(workspace.getBlockById(event.blockId).type)))
									&& (!(next.inputList[0].fieldRow[1].getValue() == "string"
										|| next.inputList[0].fieldRow[1].getValue() == "number")
									&& warningAttrs.includes(workspace.getBlockById(event.blockId).type)
									|| ((next.inputList[0].fieldRow[1].getValue() == "string"
									|| next.inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(workspace.getBlockById(event.blockId).type)))) {
									//console.log(root.type);
									console.log('hello3');
									next.outputConnection.disconnect();
									/*if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null)
										workspace.getBlockById(event.blockId).nextConnection.disconnect();*/
									/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
									workspace.getBlockById(event.blockId).previousConnection.disconnect();
									if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
										var nextConn = workspace.getBlockById(event.blockId).nextConnection;
										workspace.getBlockById(event.blockId).nextConnection.disconnect();
										prevConn.connect(nextConn);
									}*/
									//console.log('hello');
									return;
								}
							}
						}
						next = workspace.getBlockById(event.blockId);
						//console.log(next.inputList[0].fieldRow[1].getValue());
						while (next.outputConnection != null && next.outputConnection.targetConnection != null
							&& next.outputConnection.targetConnection.getSourceBlock().type != "block_model"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "block_location"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_model_first"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_model_second"
							&& next.outputConnection.targetConnection.getSourceBlock().type != "set_location") {
							next = next.outputConnection.targetConnection.getSourceBlock();
							//console.log(next.inputList[0].fieldRow[1].getValue());
							//console.log(next.type);
					    	//console.log(root.type);
					    	console.log('erh0');
							if (next.type == "attr_block_type") {
								hasName = true;
								console.log('erh');
								console.log(((next.inputList[0].fieldRow[1].getValue() == "string"
									|| next.inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(workspace.getBlockById(event.blockId).type)));
								if (!((next.inputList[0].fieldRow[1].getValue() == "file"
									&& fileAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "image"
									&& imageAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "archive"
									&& archiveAttrs.includes(workspace.getBlockById(event.blockId).type)))
									&& (!(next.inputList[0].fieldRow[1].getValue() == "string"
										|| next.inputList[0].fieldRow[1].getValue() == "number")
									&& warningAttrs.includes(workspace.getBlockById(event.blockId).type)
									|| ((next.inputList[0].fieldRow[1].getValue() == "string"
									|| next.inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(workspace.getBlockById(event.blockId).type)))) {
									//console.log(root.type);
									console.log('hello4');
									next.outputConnection.disconnect();
									/*if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null)
										workspace.getBlockById(event.blockId).nextConnection.disconnect();*/
									/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
									workspace.getBlockById(event.blockId).previousConnection.disconnect();
									if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
										var nextConn = workspace.getBlockById(event.blockId).nextConnection;
										workspace.getBlockById(event.blockId).nextConnection.disconnect();
										prevConn.connect(nextConn);
									}*/
									//console.log('hello');
									return;
								}
							}
						}
						if (!hasName && workspace.getBlockById(event.blockId).outputConnection != null &&
							workspace.getBlockById(event.blockId).outputConnection.targetConnection != null) {
							console.log('hello5');
							workspace.getBlockById(event.blockId).outputConnection.disconnect();
						}
					}
				}
				/*if (event.type == Blockly.Events.BLOCK_DRAG) {
					var allBlocks = workspace.getAllBlocks(false);
					for (var i = 0; i < allBlocks.length; i++) {
						if (allBlocks[i].type == 'block') {

						}
						if (this.distanceFrom(allBlocks[i]) > distance)
					}
				}*/
				/*if (event.type == Blockly.Events.BLOCK_CHANGE) {
					if (workspace.getBlockById(event.blockId).type === "text" &&
						workspace.getBlockById(event.blockId).getParent() === "attr_location") {
						for (let i = 0; i < workspace.getBlockById(event.blockId).getParent().options.length; i++) {
							if (workspace.getBlockById(event.blockId).getParent().options[i].enabled) {
								if 
							}
						}

					}
				}*/
			  var code = bmlGenerator.workspaceToCode(workspace);
			  document.getElementById('textarea').value = code;
			}
			workspace.addChangeListener(myUpdateFunction);
		</script>
	</body>
</html>