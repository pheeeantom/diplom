<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Test - Blockly</title>
		<script src="blockly/blockly_compressed.js"></script>
		<script src="blockly/blocks_compressed.js"></script>
		<script src="blockly/generators/bml.js"></script>
		<script src="blockly/msg/ru.js"></script>
	</head>
	<body>
		<div id="blocklyDiv" style="position: absolute;"></div>
		<div id="blocklyArea" style="width:10000px;height:2000px"></div>
		<!--<xml id="toolbox" style="display: none">
		    <category name="Text">
			    <block type="string_length"></block>
			  </category>
		</xml>-->
		<textarea id="textarea">
		</textarea>
		<script>
		/*Blockly.Blocks['string_length'] = {
			  init: function() {
			    this.jsonInit(
					{
					  "message0": "length of %1",
					  "args0": [
					    {
					      "type": "field_input",
					      "name":"VALUE"
					    }
					  ]
					}
			    );
			  }
			};
		  var workspace = Blockly.inject('blocklyDiv',
		      {toolbox: document.getElementById('toolbox')});
			function myUpdateFunction(event) {
			  var code = Blockly.bml.workspaceToCode(workspace);
			  document.getElementById('textarea').value = code;
			}
			workspace.addChangeListener(myUpdateFunction);*/
			  var blocklyArea = document.getElementById('blocklyArea');
  			var blocklyDiv = document.getElementById('blocklyDiv');
			var defaultOptions = {
			  comments: true,
			  // ...
			  toolbox: bmlToolbox,
			  // ...
			};
			var workspace = Blockly.inject('blocklyDiv', defaultOptions);
			var onresize = function(e) {
		    // Compute the absolute coordinates and dimensions of blocklyArea.
		    var element = blocklyArea;
		    var x = 0;
		    var y = 0;
		    do {
		      x += element.offsetLeft;
		      y += element.offsetTop;
		      element = element.offsetParent;
		    } while (element);
		    // Position blocklyDiv over blocklyArea.
		    blocklyDiv.style.left = x + 'px';
		    blocklyDiv.style.top = y + 'px';
		    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
		    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
		    Blockly.svgResize(workspace);
		  };
		  window.addEventListener('resize', onresize, false);
		  onresize();
		  Blockly.svgResize(workspace);
			function myUpdateFunction(event) {
				if (event.type == Blockly.Events.BLOCK_MOVE) {
				    if (workspace.getBlockById(event.blockId).type === "block") {
				    	let root = workspace.getBlockById(event.blockId).getParent();
				    	while (root.type !== "group" && root.type !== "model" && root.type !== "location") {
				    		root = root.getParent();
				    	}
				    	if (root.type === "model" || root.type === "location") {
				    		workspace.getBlockById(event.blockId).previousConnection.disconnect();
				    	}
				    }
				  }	
			  /*var code = bmlGenerator.workspaceToCode(workspace);
			  document.getElementById('textarea').value = code;*/
			}
			workspace.addChangeListener(myUpdateFunction);
		</script>
	</body>
</html>