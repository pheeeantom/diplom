<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Test - Blockly</title>
		<script src="blockly/blockly_compressed.js"></script>
		<script src="blockly/blocks_compressed.js"></script>
		<script src="blockly/generators/bml.js"></script>
		<script src="blockly/msg/ru.js"></script>
	</head>
	<body>
		<div id="blocklyDiv" style="position: absolute;"></div>
		<div id="blocklyArea" style="width:10000px;height:2000px"></div>
		<!--<xml id="toolbox" style="display: none">
		    <category name="Text">
			    <block type="string_length"></block>
			  </category>
		</xml>-->
		<textarea id="textarea">
		</textarea>
		<script>
		/*Blockly.Blocks['string_length'] = {
			  init: function() {
			    this.jsonInit(
					{
					  "message0": "length of %1",
					  "args0": [
					    {
					      "type": "field_input",
					      "name":"VALUE"
					    }
					  ]
					}
			    );
			  }
			};
		  var workspace = Blockly.inject('blocklyDiv',
		      {toolbox: document.getElementById('toolbox')});
			function myUpdateFunction(event) {
			  var code = Blockly.bml.workspaceToCode(workspace);
			  document.getElementById('textarea').value = code;
			}
			workspace.addChangeListener(myUpdateFunction);*/
			  var blocklyArea = document.getElementById('blocklyArea');
  			var blocklyDiv = document.getElementById('blocklyDiv');
			var defaultOptions = {
			  comments: true,
			  // ...
			  toolbox: bmlToolbox,
			  // ...
			};
			var workspace = Blockly.inject('blocklyDiv', defaultOptions);
			var onresize = function(e) {
		    // Compute the absolute coordinates and dimensions of blocklyArea.
		    var element = blocklyArea;
		    var x = 0;
		    var y = 0;
		    do {
		      x += element.offsetLeft;
		      y += element.offsetTop;
		      element = element.offsetParent;
		    } while (element);
		    // Position blocklyDiv over blocklyArea.
		    blocklyDiv.style.left = x + 'px';
		    blocklyDiv.style.top = y + 'px';
		    blocklyDiv.style.width = blocklyArea.offsetWidth + 'px';
		    blocklyDiv.style.height = blocklyArea.offsetHeight + 'px';
		    Blockly.svgResize(workspace);
		  };
		  window.addEventListener('resize', onresize, false);
		  onresize();

		  /*function findDescendants(root, sets) {
		  	if (root.inputList[3].connection.targetConnection == null) {
		  		return;
		  	}
		  	root = root.inputList[3].connection.targetConnection.getSourceBlock();
		  	//console.log(root);
		  	var next = root;
		  	if (next.type == "set") {
				sets.push(next);
			}
			while (next.nextConnection.targetConnection != null) {
				next = next.nextConnection.targetConnection.getSourceBlock();
				if (next.type == "set") {
					sets.push(next);
				}
				findDescendants(next, sets);
			}
			//console.log(root);
		  }*/

		  /*function findIds(set, ids) {
		  	if ()
		  	while (set.inputList[2].connection.targetConnection.getSourceBlock()) {

		  	}
		  }*/

		  var ids = [];

		  function updateId(id) {
		  	if (id.type == 'attr_set_id') {
		  		Blockly.Events.fire(new (Blockly.Events.get(Blockly.Events.BLOCK_CHANGE))(id, 'collapsed', null, id.collapsed_, id.inputList[0].fieldRow[1].getValue()));
		  	}
		  }

		  Blockly.svgResize(workspace);
			function myUpdateFunction(event) {
				if (event.type == Blockly.Events.BLOCK_CHANGE) {
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type === "attr_set_id") {
						var next = workspace.getBlockById(event.blockId);
						while (next.previousConnection != null && next.previousConnection.targetConnection != null) {
							next = next.previousConnection.targetConnection.getSourceBlock();
							if (next.type == "location") {
								var idsStr = [];
								for (var i = 0; i < ids.length; i++) {
									idsStr.push(Object.values(ids[i])[0]);
								}
								console.log(idsStr);
								if (!idsStr.includes(event.newValue)) {
									workspace.getBlockById(event.blockId).setColour(0);
								}
								else {
									workspace.getBlockById(event.blockId).setColour(180);
								}
								break;
							}
							if (next.type == "model") {
								for (var i = 0; i < ids.length; i++) {
									var obj = ids[i];
									var name = event.blockId;
									if (obj[name] !== undefined) {
										ids.splice(i, 1);
									}
								}
								var obj = {};
								var name = event.blockId;
								var val = event.newValue;
								obj[name] = val;
								ids.push(obj);
								break;
							}
						}
					}
					//console.log(ids);
				}

				if (event.type == Blockly.Events.BLOCK_MOVE) {
					if (workspace.getBlockById(event.blockId) != null
						&& (workspace.getBlockById(event.blockId).type === "block_location"
						|| workspace.getBlockById(event.blockId).type === "set_location")) {
						//console.log('kkk');
						let child = workspace.getBlockById(event.blockId);
				    	let root = child.getParent();
				    	if (root != null) {
					    	while (root != null && root.getInputTargetBlock("DO") != child) {
					    		child = child.getParent();
					    		root = child.getParent();
					    	}
				    		if (workspace.getBlockById(event.blockId).type === "block_location") {
				    			if (root != null && (root.type === "model" || root.type === "location")) {
				    				console.log('hello-1');
					    			workspace.getBlockById(event.blockId).previousConnection.disconnect();
					    			return;
					    		}
				    		}
				    		if (workspace.getBlockById(event.blockId).type === "set_location") {
				    			//console.log('hello');
				    			var next = workspace.getBlockById(event.blockId);
				    			while (next.nextConnection != null && next.nextConnection.targetConnection != null) {
									next = next.nextConnection.targetConnection.getSourceBlock();
									//console.log(next.type);
							    	//console.log(root.type);
									if (root != null
										&& (next.type == 'block_location' && (root.type == 'location' ||
										root.type == 'model'))) {
										//console.log(root.type);
										console.log('hello0');
										workspace.getBlockById(event.blockId).previousConnection.disconnect();
										return;
									}
								}
				    		}
				    	}
					    	/*let root = workspace.getBlockById(event.blockId).getParent();
					    	while (root.type !== "group" && root.type !== "model" && root.type !== "location") {
					    		root = root.getParent();
					    	}
					    	if (root.type === "model" || root.type === "location") {
					    		workspace.getBlockById(event.blockId).previousConnection.disconnect();
					    	}*/
					    	/*let root = workspace.getBlockById(event.blockId);
					    	while (root.getOnlyValueConnection_() === null) {
					    		root = root.getParent();
					    	}*/
					}
					workspace.getAllBlocks(false).forEach(block => updateId(block));
					/*if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type == "attr_set_id") {
						var next = workspace.getBlockById(event.blockId);
						while (next.previousConnection.targetConnection != null) {
							next = next.previousConnection.targetConnection.getSourceBlock();
							if (next.type == "model") {
								//console.log('mod');
								break;
							}
							if (next.type == "location") {
								//console.log('loc');
								while (next.previousConnection.targetConnection != null) {
									next = next.previousConnection.targetConnection.getSourceBlock();
									if (next.type == "model") {
										if (next.inputList[1].connection.targetConnection != null) {
											var root = next.inputList[1].connection.targetConnection.getSourceBlock();
											var sets = [root];
											next = root;
											while (next.nextConnection.targetConnection != null) {
												next = next.nextConnection.targetConnection.getSourceBlock();
												if (next.type == "set") {
													sets.push(next);
												}
											}
											//console.log(sets);
											sets.forEach(set => findDescendants(set, sets));
											sets.forEach(set => findIds(set, ids));
											break;
										}
									}
								}
							}
						}
					}*/
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type.startsWith("attr_")) {
						var next = workspace.getBlockById(event.blockId);
						while (next.nextConnection != null && next.nextConnection.targetConnection != null) {
							next = next.nextConnection.targetConnection.getSourceBlock();
							if (next.type == workspace.getBlockById(event.blockId).type) {
								console.log('hello0.1');
								workspace.getBlockById(event.blockId).nextConnection.disconnect();
								return;
							}
						}
						next = workspace.getBlockById(event.blockId);
						while (next.previousConnection != null && next.previousConnection.targetConnection != null) {
							next = next.previousConnection.targetConnection.getSourceBlock();
							if (next.type == workspace.getBlockById(event.blockId).type) {
								console.log('hello0.2');
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								return;
							}
						}
					}
					var fileAttrs = [
						"attr_block_path",
						"attr_block_mimes"
					];
					var imageAttrs = [
						"attr_block_width",
						"attr_block_height",
						"attr_block_resize"
					];
					var archiveAttrs = [
						"attr_block_method",
						"attr_block_ratio",
						"attr_block_comment",
						"attr_block_unpacked_size"
					];
					var warningAttrs = fileAttrs.concat(imageAttrs).concat(archiveAttrs);
					var imageAttrs = fileAttrs.concat(imageAttrs);
					var archiveAttrs = fileAttrs.concat(archiveAttrs);
					if (workspace.getBlockById(event.blockId) != null
						&& workspace.getBlockById(event.blockId).type == "attr_block_type") {
						//console.log('HELLO');
						var next = workspace.getBlockById(event.blockId);
						while (next.nextConnection != null && next.nextConnection.targetConnection != null) {
							next = next.nextConnection.targetConnection.getSourceBlock();
							//console.log(next.type);
					    	//console.log(root.type);
							if (!((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "file"
								&& fileAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "image"
								&& imageAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "archive"
								&& archiveAttrs.includes(next.type)))
								&& (!(workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number")
								&& warningAttrs.includes(next.type)
								|| ((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(next.type)))) {
								//console.log(root.type);
								console.log('hello1');
								workspace.getBlockById(event.blockId).nextConnection.disconnect();
								/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
									var nextConn = workspace.getBlockById(event.blockId).nextConnection;
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									prevConn.connect(nextConn);
								}*/
								//console.log('hello');
								return;
							}
						}
						next = workspace.getBlockById(event.blockId);
						while (next.previousConnection != null && next.previousConnection.targetConnection != null
							&& next.previousConnection.targetConnection.getSourceBlock().type != "block_model"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "block_location"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "set_model_first"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "set_model_second"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "set_location") {
							//console.log('hello');
							next = next.previousConnection.targetConnection.getSourceBlock();
							//console.log(next.type);
					    	//console.log(root.type);
							if (!((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "file"
								&& fileAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "image"
								&& imageAttrs.includes(next.type))
								|| (workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "archive"
								&& archiveAttrs.includes(next.type)))
								&& (!(workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number")
								&& warningAttrs.includes(next.type)
								|| ((workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "string"
									|| workspace.getBlockById(event.blockId).inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(next.type)))) {
								console.log('hello2');
								//console.log(root.type);
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
								workspace.getBlockById(event.blockId).previousConnection.disconnect();
								if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
									var nextConn = workspace.getBlockById(event.blockId).nextConnection;
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									prevConn.connect(nextConn);
								}*/
								//console.log('hello');
								return;
							}
						}
					}
					if (workspace.getBlockById(event.blockId) != null
						&& warningAttrs.includes(workspace.getBlockById(event.blockId).type)) {
						//console.log(12345);
						//console.log('hello1');
						var hasName = false; 
						var next = workspace.getBlockById(event.blockId);
						while (next.nextConnection != null && next.nextConnection.targetConnection != null) {
							next = next.nextConnection.targetConnection.getSourceBlock();
							//console.log(next.type);
					    	//console.log(root.type);
							if (next.type == "attr_block_type") {
								hasName = true;
								if (!((next.inputList[0].fieldRow[1].getValue() == "file"
									&& fileAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "image"
									&& imageAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "archive"
									&& archiveAttrs.includes(workspace.getBlockById(event.blockId).type)))
									&& (!(next.inputList[0].fieldRow[1].getValue() == "string"
										|| next.inputList[0].fieldRow[1].getValue() == "number")
									&& warningAttrs.includes(workspace.getBlockById(event.blockId).type)
									|| ((next.inputList[0].fieldRow[1].getValue() == "string"
									|| next.inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(workspace.getBlockById(event.blockId).type)))) {
									//console.log(root.type);
									console.log('hello3');
									workspace.getBlockById(event.blockId).nextConnection.disconnect();
									/*if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null)
										workspace.getBlockById(event.blockId).nextConnection.disconnect();*/
									/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
									workspace.getBlockById(event.blockId).previousConnection.disconnect();
									if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
										var nextConn = workspace.getBlockById(event.blockId).nextConnection;
										workspace.getBlockById(event.blockId).nextConnection.disconnect();
										prevConn.connect(nextConn);
									}*/
									//console.log('hello');
									return;
								}
							}
						}
						next = workspace.getBlockById(event.blockId);
						//console.log(next.inputList[0].fieldRow[1].getValue());
						while (next.previousConnection != null && next.previousConnection.targetConnection != null
							&& next.previousConnection.targetConnection.getSourceBlock().type != "block_model"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "block_location"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "set_model_first"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "set_model_second"
							&& next.previousConnection.targetConnection.getSourceBlock().type != "set_location") {
							next = next.previousConnection.targetConnection.getSourceBlock();
							//console.log(next.inputList[0].fieldRow[1].getValue());
							//console.log(next.type);
					    	//console.log(root.type);
					    	console.log('erh0');
							if (next.type == "attr_block_type") {
								hasName = true;
								console.log('erh');
								console.log(((next.inputList[0].fieldRow[1].getValue() == "string"
									|| next.inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(workspace.getBlockById(event.blockId).type)));
								if (!((next.inputList[0].fieldRow[1].getValue() == "file"
									&& fileAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "image"
									&& imageAttrs.includes(workspace.getBlockById(event.blockId).type))
									|| (next.inputList[0].fieldRow[1].getValue() == "archive"
									&& archiveAttrs.includes(workspace.getBlockById(event.blockId).type)))
									&& (!(next.inputList[0].fieldRow[1].getValue() == "string"
										|| next.inputList[0].fieldRow[1].getValue() == "number")
									&& warningAttrs.includes(workspace.getBlockById(event.blockId).type)
									|| ((next.inputList[0].fieldRow[1].getValue() == "string"
									|| next.inputList[0].fieldRow[1].getValue() == "number") && warningAttrs.includes(workspace.getBlockById(event.blockId).type)))) {
									//console.log(root.type);
									console.log('hello4');
									workspace.getBlockById(event.blockId).previousConnection.disconnect();
									/*if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null)
										workspace.getBlockById(event.blockId).nextConnection.disconnect();*/
									/*var prevConn = workspace.getBlockById(event.blockId).previousConnection.targetConnection.getSourceBlock().nextConnection;
									workspace.getBlockById(event.blockId).previousConnection.disconnect();
									if (workspace.getBlockById(event.blockId).nextConnection.targetConnection != null) {
										var nextConn = workspace.getBlockById(event.blockId).nextConnection;
										workspace.getBlockById(event.blockId).nextConnection.disconnect();
										prevConn.connect(nextConn);
									}*/
									//console.log('hello');
									return;
								}
							}
						}
						if (!hasName && workspace.getBlockById(event.blockId).previousConnection != null &&
							workspace.getBlockById(event.blockId).previousConnection.targetConnection != null) {
							console.log('hello5');
							workspace.getBlockById(event.blockId).previousConnection.disconnect();
						}
					}
				}
				/*if (event.type == Blockly.Events.BLOCK_DRAG) {
					var allBlocks = workspace.getAllBlocks(false);
					for (var i = 0; i < allBlocks.length; i++) {
						if (allBlocks[i].type == 'block') {

						}
						if (this.distanceFrom(allBlocks[i]) > distance)
					}
				}*/
				/*if (event.type == Blockly.Events.BLOCK_CHANGE) {
					if (workspace.getBlockById(event.blockId).type === "text" &&
						workspace.getBlockById(event.blockId).getParent() === "attr_location") {
						for (let i = 0; i < workspace.getBlockById(event.blockId).getParent().options.length; i++) {
							if (workspace.getBlockById(event.blockId).getParent().options[i].enabled) {
								if 
							}
						}

					}
				}*/
			  /*var code = bmlGenerator.workspaceToCode(workspace);
			  document.getElementById('textarea').value = code;*/
			}
			workspace.addChangeListener(myUpdateFunction);
		</script>
	</body>
</html>